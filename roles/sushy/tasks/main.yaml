---
- name: Install required rpms
  dnf:
    name:
      - libvirt-devel
      - gcc
      - python3-devel
      - python3-virtualenv
      - python3-cryptography

- name: Create python venv and install modules
  pip:
    name:
      - sushy-tools
      - libvirt-python
      - cryptography
    virtualenv: "{{ sushy_dir }}"
    virtualenv_site_packages: yes

- name: Generate private key for sushy server
  community.crypto.openssl_privatekey:
    path: "{{ sushy_dir }}/sushy.key"
    size: "{{ key_size | default('2048') }}"
    type: "{{ key_type | default('RSA') }}"

- name: Generate cert for sushy server
  community.crypto.x509_certificate:
    path: "{{ sushy_dir }}/sushy.crt"
    privatekey_path: "{{ sushy_dir }}/sushy.key"
    provider: selfsigned

- name: Template sushy.conf
  template:
    src: sushy.conf.j2
    dest: "{{ sushy_dir }}/sushy.conf"

- name: Template systemd unit
  template:
    src: sushy.service.j2
    dest: "/etc/systemd/system/sushy.service"

- name: Enable and start sushy
  systemd:
    name: sushy.service
    state: started
    enabled: yes
    daemon_reload: yes
